# 임베딩 검색 가이드

## 개요

근로계약서 분석 시스템의 통합 임베딩 검색 시스템 사용 가이드입니다. PDF 문서와 법률 데이터를 통합 검색할 수 있습니다.

## 현재 임베딩 구성

### 전체 통계

| 구분 | PDF 문서 | 법률 데이터 | 합계 |
|------|---------|------------|------|
| 원본 문서 | 4개 | 2,931건 | 2,935개 |
| 청크 수 | 674개 | 14,549개 | **15,223개** |
| 임베딩 차원 | 1024 | 1024 | 1024 |
| 모델 | KURE-v1 | KURE-v1 | KURE-v1 |

### 데이터 소스

**1. PDF 문서 (674개 청크)**

| 문서명 | 유형 | 청크 수 |
|--------|------|---------|
| 개정 표준근로계약서(2025년) | 계약서 양식 | 약 50개 |
| 채용절차 공정화 법률 매뉴얼 | 법률 매뉴얼 | 약 300개 |
| 개정 표준취업규칙(2025년) | 취업 규칙 | 약 250개 |
| 2025년 최저임금 안내 | 안내문 | 약 20개 |
| 채용절차 공정화 리플릿 | 리플릿 | 약 54개 |

**2. 법률 데이터 (14,549개 청크)**

| 데이터 타입 | 원본 건수 | 청크 수 | 비율 |
|------------|----------|---------|------|
| 법령해석례 | 135건 | 589개 | 4.0% |
| 판례 | 969건 | 10,576개 | 72.7% |
| 고용노동부 법령해설 | 1,827건 | 3,384개 | 23.3% |
| **합계** | **2,931건** | **14,549개** | **100%** |

### 검색 키워드 (13개)

법률 데이터는 다음 키워드로 수집되었습니다:

- 근로계약, 근로기준법, 최저임금, 퇴직금
- 해고, 임금, 연차, 근로시간
- 휴게시간, 휴일, 연장근로, 통상임금, 수습기간

## 청킹 기준

### PDF 문서 청킹

**전략**: 컨텍스트 보존 청킹 (Context-preserving Chunking)

**파라미터**:
- 최대 청크 길이: 500자
- 최소 청크 길이: 50자
- 오버랩: 50자

**특징**:
- 단락 경계 유지
- 제목/소제목 컨텍스트 포함
- 카테고리별 메타데이터 추가

**메타데이터**:
```json
{
  "source_type": "pdf",
  "source": "문서명",
  "category": "근로시간|임금|채용절차|...",
  "doc_type": "manual|employment_rules|...",
  "keywords": ["키워드1", "키워드2", ...],
  "page": 페이지번호,
  "content": "텍스트 내용"
}
```

### 법률 데이터 청킹

**전략**: 구조 기반 의미 청킹 (Structure-aware Semantic Chunking)

**파라미터**:
- 최대 청크 길이: 1000자
- 최소 청크 길이: 150자

**법령해석례 청킹**:
```
청크 1: 안건명 + 질의요지 (약 500자)
청크 2: 회답 (500-1000자, 분할 가능)
청크 3: 이유 (500-1000자, 분할 가능)
```

**판례 청킹**:
```
청크 1: 사건정보 + 판시사항 (약 500자)
청크 2: 판결요지 (1000자, 분할 가능)
청크 3: 판례내용 (800자 단위 분할)
청크 4: 참조조문 (있는 경우)
```

**고용노동부 청킹**:
```
청크 1: 안건명 + 질의요지 (약 500자)
청크 2: 회답 (500-1000자, 분할 가능)
청크 3: 이유 (500-1000자, 분할 가능)
청크 4: 관련법령 (있는 경우)
```

**메타데이터**:
```json
{
  "source_type": "legal",
  "doc_type": "interpretation|precedent|labor_ministry",
  "source_id": "문서 ID",
  "title": "사건명/안건명",
  "case_number": "사건번호",
  "court": "법원명",
  "date": "날짜",
  "chunk_type": "question|answer|reason|case_info|summary|content|references",
  "chunk_index": 청크 인덱스,
  "total_chunks": 전체 청크 수,
  "search_keyword": "수집 키워드",
  "content": "텍스트 내용"
}
```

## 임베딩 모델

**모델**: KURE-v1 (nlpai-lab/KURE-v1)

**특징**:
- 한국어 법률 문서 특화 모델
- 임베딩 차원: 1024
- 최대 시퀀스 길이: 512 tokens
- 정규화: True (코사인 유사도 최적화)

## 검색 테스트 방법

### 1. 스크립트 위치

```bash
ai/preprocessing/test/search.py
```

### 2. 사용 방법

**방법 1: 대화형 모드**

```bash
cd ai/preprocessing/test
python search.py i
```

대화형 모드에서 쿼리 입력:
- 기본 검색: `수습기간 3개월`
- 필터 적용: `최저임금 @legal`
- 결과 개수: `연차 #10`
- 종료: `q` 또는 `exit`

**방법 2: 직접 쿼리**

```bash
cd ai/preprocessing/test
python search.py "수습기간 3개월"
```

**방법 3: 사전 정의된 테스트**

```bash
cd ai/preprocessing/test
python search.py t
```

8개의 테스트 케이스가 자동 실행됩니다.

### 3. 필터 옵션

검색 시 다음 필터를 사용할 수 있습니다:

| 필터 | 설명 | 예시 |
|------|------|------|
| `@pdf` | PDF 문서만 검색 | `최저임금 @pdf` |
| `@legal` | 법률 데이터만 검색 | `수습기간 @legal` |
| `@interpretation` | 법령해석례만 검색 | `퇴직금 @interpretation` |
| `@precedent` | 판례만 검색 | `해고 @precedent` |
| `@labor_ministry` | 고용노동부만 검색 | `최저임금 @labor_ministry` |

### 4. 검색 예시

**예시 1: 통합 검색**

```
검색 쿼리: 수습기간 3개월

상위 5개 결과:
1. 유사도: 0.6179 (PDF - 표준취업규칙)
2. 유사도: 0.6050 (고용노동부 - 수습기간 해설)
3. 유사도: 0.5990 (고용노동부 - 퇴직금 산정)
...
```

**예시 2: 법률 데이터만 검색**

```
검색 쿼리: 수습기간 6개월 @legal

필터: {'source_type': 'legal'}
필터 적용 후: 14,549개 청크

상위 5개 결과:
1. 유사도: 0.5848 (고용노동부 - 수습기간 해고)
2. 유사도: 0.5831 (고용노동부 - 계속근로기간)
...
```

**예시 3: 판례만 검색**

```
검색 쿼리: 기간제 계약 갱신 @precedent

필터: {'source_type': 'legal', 'doc_type': 'precedent'}
필터 적용 후: 10,576개 청크

상위 3개 결과:
1. 유사도: 0.7455 (판례 - 해고무효확인)
2. 유사도: 0.7311 (판례 - 부당해고구제)
...
```

### 5. 검색 결과 해석

**유사도 점수**:
- 0.7 이상: 매우 관련성 높음
- 0.6-0.7: 관련성 높음
- 0.5-0.6: 보통
- 0.5 미만: 관련성 낮음

**메타데이터 활용**:
- 데이터 타입으로 출처 확인 (PDF/법률)
- 문서 타입으로 법률 근거 종류 확인
- 사건번호/날짜로 최신성 판단

## 데이터 파일 위치

### 원본 데이터

```
ai/data/raw/
├── documents/                    # PDF 원본
│   ├── guides/                   # 안내 문서
│   └── standard_contracts/       # 표준 계약서/규칙
└── api/                          # 법률 데이터 원본
    ├── interpretations_20251027.json    # 법령해석례 (135건, 1.1MB)
    ├── precedents_20251027.json         # 판례 (969건, 16MB)
    └── labor_ministry_20251027.json     # 고용노동부 (1,827건, 5MB)
```

### 처리된 데이터

```
ai/data/processed/
├── chunks/                       # 청킹 결과
│   ├── all_chunks.json                           # PDF 청크 (674개)
│   ├── legal_chunks_20251027.json                # 법률 청크 (14,549개)
│   └── legal_chunks_metadata_20251027.json       # 법률 청크 메타데이터
└── embeddings/                   # 임베딩 결과
    ├── chunks_with_embeddings.json                        # PDF 임베딩 (674개, 20MB)
    ├── legal_chunks_with_embeddings_20251027.json         # 법률 임베딩 (14,549개, 429MB)
    ├── legal_embeddings_20251027.npy                      # 법률 임베딩 NumPy (57MB)
    └── legal_embeddings_metadata_20251027.json            # 메타데이터
```

## 성능 및 제한사항

### 현재 성능

- **검색 속도**: 15,223개 청크에서 약 1-2초 (CPU 기준)
- **정확도**: 60-70% (테스트 쿼리 기준)
- **메모리**: 약 500MB (모델 + 임베딩)

### 제한사항

**1. 데이터 커버리지**

현재 법률 데이터는 13개 키워드로 수집되어 일부 주제는 부족할 수 있습니다:
- 포함: 근로시간, 임금, 연차, 퇴직금 등 핵심 주제
- 부족: 육아휴직, 출산휴가, 직장내괴롭힘, 특수고용직 등

**2. 검색 품질**

- 법률 용어가 정확할수록 검색 품질 향상
- 구어체 쿼리는 정확도 다소 낮음
- 복합 질의(여러 주제 동시)는 정확도 감소

**3. 시스템 요구사항**

- Python 3.9+
- 메모리 2GB 이상 권장
- KURE-v1 모델 자동 다운로드 필요 (인터넷 연결)

## 개선 방향

### 단기 개선

1. **검색 키워드 확장**: 13개 → 25개 키워드
   - 목표: 법률 데이터 5,000-6,000건 확보

2. **하이브리드 검색 구현**:
   - BM25 (키워드) + Vector (의미) 결합
   - Elasticsearch 활용

3. **Re-ranking 추가**:
   - Cross-encoder 모델로 재순위화
   - 정확도 10-15% 향상 기대

### 장기 개선

1. **실시간 업데이트**:
   - 최신 판례 자동 수집
   - 월 1회 데이터 갱신

2. **도메인 특화 미세조정**:
   - KURE-v1을 근로계약서 도메인으로 추가 학습
   - 정확도 70% → 80% 목표

3. **멀티모달 검색**:
   - 계약서 이미지 직접 검색
   - OCR + 임베딩 통합

## 문제 해결

### 모델 로딩 오류

**문제**: KURE-v1 모델 다운로드 실패

**해결**:
```bash
# 수동 다운로드
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('nlpai-lab/KURE-v1')"
```

### 메모리 부족

**문제**: 임베딩 로딩 시 메모리 부족

**해결**: NumPy 파일 사용 (JSON 대신)
```python
# 대용량 데이터의 경우
embeddings = np.load('legal_embeddings_20251027.npy')
```

### 검색 결과 없음

**문제**: 특정 필터로 검색 시 결과 없음

**확인사항**:
1. 필터 철자 확인 (@legal, @precedent 등)
2. 해당 문서 타입에 데이터 존재 여부 확인
3. 키워드가 수집 범위에 포함되는지 확인

## 관련 문서

- [PDF 데이터 처리 파이프라인](../data-pipeline/pdf-processing.md)
- [법률 데이터 파이프라인](../data-pipeline/legal-data-pipeline.md)
- [법률 데이터 타입 가이드](../data-pipeline/legal-data-types.md)
- [프로젝트 구조](../project/project-structure.md)

## 연락처

문제 발생 시 팀 리더에게 문의하세요.
